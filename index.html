<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet-I Booking System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        :root {
            --pixel-bg: #050914;
            --pixel-card: #1e293b;
            --pixel-accent: #3b82f6;
            --pixel-text: #ffffff;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: var(--pixel-bg);
            image-rendering: pixelated;
            margin: 0;
            color: white;
            overflow-x: hidden;
        }

        .custom-cursor { cursor: crosshair; }
        .retro-font { font-family: 'Press Start 2P', cursive; }

        /* Dynamic Star Background */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 200px 200px; opacity: 0.3; z-index: 0;
            animation: twinkle 5s infinite;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.5; } }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 50;
        }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 4px #fbbf24); } 50% { filter: drop-shadow(0 0 12px #fbbf24); } }
        .animate-glow { animation: pulse-glow 2s infinite; }

        .pixel-btn {
            box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.5); transition: transform 0.1s; cursor: pointer;
        }
        .pixel-btn:active { transform: translateY(2px); box-shadow: inset -2px -2px 0px 0px rgba(0,0,0,0.5); }
        
        ::-webkit-scrollbar { width: 10px; background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border: 2px solid #0f172a; }

        /* Excel Styles */
        .retro-table-container { border: 4px solid white; box-shadow: 4px 4px 0px #000; background: #0f172a; overflow-x: auto; }
        .retro-table { width: 100%; border-collapse: collapse; font-family: 'VT323', monospace; font-size: 1.2rem; color: #4ade80; white-space: nowrap; }
        .retro-table th { background: #1e293b; color: #fbbf24; text-transform: uppercase; padding: 12px; border: 2px solid #334155; text-align: left; font-family: 'Press Start 2P', cursive; font-size: 0.7rem; letter-spacing: 1px; }
        .retro-table td { padding: 10px; border: 2px solid #334155; }
        .retro-table tr:hover { background: #1e293b; color: white; cursor: crosshair; }
        .retro-table .row-id { color: #94a3b8; font-family: monospace; }
        
        /* Auth Form Styles */
        .auth-input { width: 100%; background: #000; border: 2px solid #fff; padding: 10px; color: #fff; font-family: 'VT323', monospace; font-size: 1.2rem; margin-bottom: 10px; }
        .auth-input:focus { border-color: #fbbf24; outline: none; }
        
        .filter-input { width: 100%; background: #000; border: 2px solid #334155; padding: 8px; color: white; font-family: 'VT323', monospace; font-size: 1.2rem; }
        .filter-input:focus { border-color: #fbbf24; outline: none; }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="scanlines"></div>
    <div id="root"></div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAO_u-iyZjPpJ2zKEMUluZpokNvwN8gcwM",
            authDomain: "planet-i-booking.firebaseapp.com",
            projectId: "planet-i-booking",
            storageBucket: "planet-i-booking.firebasestorage.app",
            messagingSenderId: "316808481662",
            appId: "1:316808481662:web:47d3b6627d9265ed9b012f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available to React globally
        window.db = db;
        window.auth = auth;
        window.authFunctions = { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            sendPasswordResetEmail
        };
        window.dbFunctions = { collection, addDoc, getDocs, query, orderBy, where, deleteDoc, updateDoc, doc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- CONSTANTS ---
        const BACKEND_URL = "http://localhost:3001";
        const ADMIN_EMAIL = "i24lata@iimidr.ac.in";
        const REQUIRED_DOMAIN = "@iimidr.ac.in";

        // --- ICONS ---
        const MapPin = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const XIcon = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const EditIcon = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const BarChart3 = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
        const Sun = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const CloudRain = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>;
        const Swords = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></line></svg>;
        const ArrowLeft = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const Sparkles = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>;
        const LogOut = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const ChevronDown = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const Coffee = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>;
        const Database = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;
        const Search = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const Filter = ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

        const VENUES = [
            { id: 's1', name: 'Badminton Court', category: 'Sports', x: 20, y: 50 },
            { id: 's2', name: 'Tennis Court', category: 'Sports', x: 15, y: 60 },
            { id: 's3', name: 'Football Turf', category: 'Sports', x: 25, y: 70 },
            { id: 's4', name: 'Cricket Cage', category: 'Sports', x: 10, y: 40 },
            { id: 's5', name: 'Table Tennis', category: 'Sports', x: 20, y: 55 },
            { id: 's6', name: 'Squash Court', category: 'Sports', x: 15, y: 45 },
            { id: 'a1', name: 'New Auditorium', category: 'Auditorium', x: 75, y: 40 },
            { id: 'a2', name: 'Old Auditorium', category: 'Auditorium', x: 70, y: 35 },
            { id: 'a3', name: 'New Audi Amphi', category: 'Auditorium', x: 80, y: 45 },
            { id: 'a4', name: 'Old Audi Amphi', category: 'Auditorium', x: 82, y: 38 },
            { id: 'c1', name: 'E-301 (Academic)', category: 'Classroom', x: 50, y: 30 },
            { id: 'c2', name: 'E-303 (Academic)', category: 'Classroom', x: 55, y: 30 },
            { id: 'c3', name: 'D-301 (Academic)', category: 'Classroom', x: 45, y: 30 },
            { id: 'st1', name: 'Studio', category: 'Studio', x: 50, y: 20 },
        ];

        const TIME_SLOTS = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];

        // --- COMPONENTS ---

        const PixelEarth = ({ venues, onVenueClick, bookings }) => {
            return (
                <div className="relative w-[600px] h-[600px] mx-auto animate-float select-none scale-90 md:scale-100">
                    <div className="absolute inset-0 rounded-full bg-blue-600/20 blur-3xl"></div>
                    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-2xl relative z-10" shapeRendering="crispEdges">
                        <circle cx="50" cy="50" r="45" fill="#3b82f6" stroke="#1e3a8a" strokeWidth="1" />
                        <path d="M30,20 h15 v5 h5 v10 h-10 v5 h-10 z" fill="#4ade80" />
                        <path d="M60,30 h20 v15 h-5 v10 h-10 v-5 h-5 z" fill="#4ade80" />
                        <path d="M25,60 h15 v10 h-5 v5 h-10 z" fill="#4ade80" />
                        <path d="M55,65 h20 v5 h-10 v10 h-10 z" fill="#4ade80" />
                        <rect x="15" y="35" width="10" height="3" fill="white" fillOpacity="0.7" />
                        <rect x="70" y="25" width="12" height="3" fill="white" fillOpacity="0.7" />
                        <rect x="40" y="80" width="15" height="3" fill="white" fillOpacity="0.7" />
                    </svg>
                    {venues.map((venue) => {
                        const hasChallenge = bookings.some(b => b.venueId === venue.id && b.openChallenge);
                        return (
                            <button key={venue.id} onClick={() => onVenueClick(venue)} style={{ top: `${venue.y}%`, left: `${venue.x}%` }} className="absolute transform -translate-x-1/2 -translate-y-1/2 group z-20 focus:outline-none">
                                <div className={`flex flex-col items-center ${hasChallenge ? 'animate-glow' : ''}`}>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" fill={hasChallenge ? '#fbbf24' : '#ef4444'} stroke="white" strokeWidth="2"/>
                                        <circle cx="12" cy="9" r="3" fill="white"/>
                                    </svg>
                                    <div className="absolute top-full mt-1 bg-black text-white text-[10px] px-2 py-1 border border-white whitespace-nowrap opacity-0 group-hover:opacity-100 retro-font pointer-events-none z-30">
                                        {venue.name}
                                        {hasChallenge && <span className="text-yellow-400 block text-[8px]">OPEN CHALLENGE</span>}
                                    </div>
                                </div>
                            </button>
                        );
                    })}
                </div>
            );
        };

        const RetroButton = ({ children, onClick, className = "", variant = "primary" }) => {
            const colors = { primary: 'bg-blue-600 hover:bg-blue-500', danger: 'bg-red-600 hover:bg-red-500', success: 'bg-green-600 hover:bg-green-500', neutral: 'bg-gray-600 hover:bg-gray-500', ai: 'bg-purple-600 hover:bg-purple-500' };
            return <button onClick={onClick} className={`${colors[variant]} text-white font-bold py-2 px-4 border-b-4 border-r-4 border-black active:border-0 active:mt-1 active:ml-1 uppercase tracking-wider font-retro text-sm transition-transform ${className}`}>{children}</button>;
        };

        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (!isLogin && !email.endsWith(REQUIRED_DOMAIN)) {
                    setError(`RESTRICTED ACCESS: Only ${REQUIRED_DOMAIN} emails are allowed.`);
                    return;
                }

                try {
                    let userCred;
                    if (isLogin) {
                        userCred = await window.authFunctions.signInWithEmailAndPassword(window.auth, email, password);
                    } else {
                        userCred = await window.authFunctions.createUserWithEmailAndPassword(window.auth, email, password);
                    }
                    // Successful login/signup will trigger onAuthStateChanged
                } catch (err) {
                    console.error(err);
                    // Handle common Firebase errors
                    if (err.code === 'auth/operation-not-allowed') {
                        setError("ERROR: Email/Password login is disabled in Firebase Console.");
                    } else if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
                        setError("ACCESS DENIED: Invalid credentials.");
                    } else if (err.code === 'auth/email-already-in-use') {
                        setError("ERROR: Email already registered.");
                    } else {
                        setError("SYSTEM ERROR: " + err.message);
                    }
                }
            };

            const handleReset = async () => {
                if (!email) return setError("ENTER EMAIL TO RESET PASSWORD");
                try {
                    await window.authFunctions.sendPasswordResetEmail(window.auth, email);
                    alert("RESET LINK SENT TO COMM CHANNEL.");
                } catch(err) { setError(err.message); }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center relative overflow-hidden text-white z-10">
                    <div className="z-10 text-center mb-8 animate-float">
                        <h1 className="text-4xl md:text-6xl text-yellow-400 mb-2 pixel-text-shadow retro-font">PLANET-I</h1>
                        <p className="text-xl text-blue-300 tracking-widest uppercase retro-font">Booking System</p>
                    </div>
                    <div className="z-10 bg-[#1e293b] p-8 border-4 border-white shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)] max-w-md w-full">
                        
                        <div className="flex justify-between mb-6 border-b-2 border-gray-600 pb-2">
                            <button onClick={()=>setIsLogin(true)} className={`retro-font text-sm ${isLogin ? 'text-yellow-400' : 'text-gray-400 hover:text-white'}`}>LOGIN</button>
                            <button onClick={()=>setIsLogin(false)} className={`retro-font text-sm ${!isLogin ? 'text-yellow-400' : 'text-gray-400 hover:text-white'}`}>SIGN UP</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 retro-font">INSTITUTE ID</label>
                                <input type="email" className="auth-input" value={email} onChange={e=>setEmail(e.target.value)} required />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 retro-font">PASSWORD</label>
                                <input type="password" className="auth-input" value={password} onChange={e=>setPassword(e.target.value)} required />
                            </div>
                            
                            {error && <p className="text-red-500 text-xs font-bold blink">{error}</p>}
                            
                            <RetroButton className="w-full mt-2">{isLogin ? 'AUTHENTICATE' : 'REGISTER ID'}</RetroButton>
                        </form>
                        
                        {isLogin && (
                            <button onClick={handleReset} className="text-xs text-blue-400 mt-4 hover:text-white block mx-auto retro-font underline decoration-dotted">
                                FORGOT PASSWORD?
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const BookingModal = ({ venue, bookingToEdit, onClose, onConfirm }) => {
            const [date, setDate] = useState(bookingToEdit ? bookingToEdit.date : '');
            const [time, setTime] = useState(bookingToEdit ? bookingToEdit.time : '');
            const [openChallenge, setOpenChallenge] = useState(bookingToEdit ? bookingToEdit.openChallenge : false);
            const [purpose, setPurpose] = useState(bookingToEdit ? bookingToEdit.purpose : '');
            const maxDays = venue.category === 'Sports' ? 2 : venue.category === 'Auditorium' ? 7 : 30;
            const today = new Date().toISOString().split('T')[0];
            const maxDateObj = new Date(); maxDateObj.setDate(maxDateObj.getDate() + maxDays);
            const maxDateStr = maxDateObj.toISOString().split('T')[0];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 font-mono backdrop-blur-sm">
                    <div className="bg-[#1e293b] border-4 border-white text-white w-full max-w-lg shadow-[10px_10px_0px_0px_#000] animate-in zoom-in duration-200">
                        <div className="bg-blue-700 p-4 border-b-4 border-white flex justify-between items-center">
                            <h2 className="text-lg text-white flex items-center gap-2 uppercase retro-font"><MapPin /> {bookingToEdit ? 'EDIT: ' : ''}{venue.name}</h2>
                            <button onClick={onClose}><XIcon className="text-white hover:text-red-400" /></button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-green-400 mb-2 uppercase text-xs retro-font">Date (Max {maxDays} Days)</label><input type="date" min={today} max={maxDateStr} className="w-full bg-black border-2 border-white p-2 text-white" value={date} onChange={e => setDate(e.target.value)} /></div>
                                <div><label className="block text-green-400 mb-2 uppercase text-xs retro-font">Time Slot</label><select className="w-full bg-black border-2 border-white p-2 text-white h-[42px]" value={time} onChange={e => setTime(e.target.value)}><option value="">Select...</option>{TIME_SLOTS.map(t => (<option key={t} value={`${t} - ${parseInt(t)+1}:00`}>{t} - {parseInt(t)+1}:00</option>))}</select></div>
                            </div>
                            <div><label className="block text-green-400 mb-2 uppercase text-xs retro-font">Purpose / Event Name</label><input type="text" className="w-full bg-black border-2 border-white p-2 text-white" placeholder="e.g. Club Meeting" value={purpose} onChange={e => setPurpose(e.target.value)} /></div>
                            {venue.category === 'Sports' && (
                                <div className="border-2 border-yellow-600 bg-yellow-900/20 p-3 flex items-center justify-between">
                                    <label className="text-yellow-400 uppercase text-xs font-bold retro-font flex items-center gap-2"><Swords /> Open Challenge?</label>
                                    <button onClick={() => setOpenChallenge(!openChallenge)} className={`w-12 h-6 border-2 border-white flex items-center px-1 transition-colors ${openChallenge ? 'bg-green-500 justify-end' : 'bg-red-500 justify-start'}`}><div className="w-4 h-4 bg-white border border-black"></div></button>
                                </div>
                            )}
                            <RetroButton onClick={() => onConfirm({ venue, date, time, openChallenge, purpose, id: bookingToEdit?.id })} className="w-full mt-4" variant="success">{bookingToEdit ? 'UPDATE BOOKING' : 'CONFIRM BOOKING'}</RetroButton>
                        </div>
                    </div>
                </div>
            );
        };

        const PixelPlanetApp = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('map');
            const [selectedVenue, setSelectedVenue] = useState(null);
            const [editingBooking, setEditingBooking] = useState(null);
            const [bookings, setBookings] = useState([]);
            const [time, setTime] = useState(new Date());
            const [weather, setWeather] = useState({ temp: '--', desc: 'Loading...', aqi: '--' });
            const [aiInsight, setAiInsight] = useState("System Idle. Waiting for data...");
            const [expandedCat, setExpandedCat] = useState(null);
            
            // Database View State
            const [searchTerm, setSearchTerm] = useState("");
            const [sortOrder, setSortOrder] = useState("asc"); 

            // --- INIT ---
            useEffect(() => {
                const checkAuth = setInterval(() => {
                    if (window.auth && window.authFunctions) {
                        clearInterval(checkAuth);
                        const unsubscribe = window.authFunctions.onAuthStateChanged(window.auth, (u) => {
                            if (u) {
                                const name = u.email.split('@')[0]; 
                                setUser({ name: name, email: u.email, role: 'Student' });
                            } else {
                                setUser(null);
                            }
                        });
                        return () => unsubscribe();
                    }
                }, 100);

                const timer = setInterval(() => setTime(new Date()), 60000);
                
                const fetchWeather = async () => {
                    try {
                        const w = await fetch('https://api.open-meteo.com/v1/forecast?latitude=22.63&longitude=75.80&current=temperature_2m,weather_code');
                        const wd = await w.json();
                        const a = await fetch('https://air-quality-api.open-meteo.com/v1/air-quality?latitude=22.63&longitude=75.80&current=us_aqi');
                        const ad = await a.json();
                        const descMap = { 0: 'Clear', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 61: 'Rain', 80: 'Showers' };
                        setWeather({ temp: wd.current.temperature_2m, desc: descMap[wd.current.weather_code] || 'Cloudy', aqi: ad.current.us_aqi });
                    } catch (e) { setWeather({ temp: '28', desc: 'Clear', aqi: '45' }); }
                };
                fetchWeather();
                return () => { clearInterval(checkAuth); clearInterval(timer); }
            }, []);

            // --- FIRESTORE ---
            useEffect(() => {
                if (!user || !window.dbFunctions) return;
                const loadBookings = async () => {
                    try {
                        const q = window.dbFunctions.query(window.dbFunctions.collection(window.db, "bookings"), window.dbFunctions.orderBy("timestamp", "desc"));
                        const querySnapshot = await window.dbFunctions.getDocs(q);
                        const loaded = [];
                        querySnapshot.forEach((doc) => loaded.push({ id: doc.id, ...doc.data() }));
                        setBookings(loaded);
                    } catch (e) { console.error("Firestore Error", e); }
                };
                loadBookings();
            }, [user, view]);

            const handleBookingConfirm = async (data) => {
                if(!data.date || !data.time) return alert("Select Date/Time");
                
                // Double Booking Check
                const isConflict = bookings.some(b => 
                    b.venueId === data.venue.id && 
                    b.date === data.date && 
                    b.time === data.time && 
                    b.id !== data.id 
                );

                if (isConflict) return alert("Slot already booked! Please choose another time.");

                const payload = { 
                    venueName: data.venue.name, 
                    venueId: data.venue.id, 
                    user: user.name, 
                    email: user.email,
                    date: data.date,
                    time: data.time,
                    purpose: data.purpose || "N/A",
                    openChallenge: data.openChallenge || false,
                    timestamp: new Date()
                };

                try {
                    if (data.id) {
                        await window.dbFunctions.updateDoc(window.dbFunctions.doc(window.db, "bookings", data.id), payload);
                        alert("Booking Updated!");
                    } else {
                        await window.dbFunctions.addDoc(window.dbFunctions.collection(window.db, "bookings"), payload);
                        alert("Booking Successful!");
                    }
                    setView('bookings');
                } catch(e) { alert("Action Failed: " + e.message); }
                
                setSelectedVenue(null);
                setEditingBooking(null);
            };

            const handleCancel = async (id) => {
                if(confirm("Cancel this booking?")) {
                    try {
                        await window.dbFunctions.deleteDoc(window.dbFunctions.doc(window.db, "bookings", id));
                        setBookings(prev => prev.filter(b => b.id !== id));
                    } catch(e) { alert("Failed to cancel."); }
                }
            };

            const handleEdit = (booking) => {
                const venueObj = VENUES.find(v => v.id === booking.venueId) || { name: booking.venueName, category: 'Unknown' };
                setEditingBooking(booking);
                setSelectedVenue(venueObj);
            };

            const toggleCategory = (cat) => setExpandedCat(expandedCat === cat ? null : cat);
            const getVenuesByCategory = (cat) => {
                const map = { 'Sports': 'Sports', 'Admin': ['Classroom', 'Studio'], 'Auditorium': 'Auditorium' };
                if (cat === 'Admin') return VENUES.filter(v => map['Admin'].includes(v.category));
                return VENUES.filter(v => v.category === cat);
            };

            const filteredBookings = bookings.filter(b => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    b.venueName.toLowerCase().includes(searchLower) ||
                    b.user.toLowerCase().includes(searchLower) ||
                    b.email.toLowerCase().includes(searchLower) ||
                    b.date.includes(searchLower)
                );
            }).sort((a, b) => {
                if (sortOrder === 'asc') {
                    return new Date(a.date) - new Date(b.date);
                } else {
                    return new Date(b.date) - new Date(a.date);
                }
            });

            if (!user) return <AuthScreen onLogin={setUser} />;

            return (
                <div className="min-h-screen flex flex-col relative custom-cursor overflow-x-hidden">
                    <header className="z-20 px-6 py-4 border-b border-white/10 bg-[#0f172a]/80 backdrop-blur-md flex justify-between items-center sticky top-0">
                        <div className="flex items-center gap-4"><div className="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/20 retro-font">P</div><div><h1 className="font-bold tracking-wider text-lg retro-font text-white">PLANET-I</h1><p className="text-xs text-gray-400 flex items-center gap-2 retro-font"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> System Operational</p></div></div>
                        <div className="flex items-center gap-4"><div className="text-right hidden sm:block retro-font"><p className="text-sm font-semibold text-green-400">{user.name}</p><p className="text-xs text-gray-400">{user.role}</p></div><button onClick={() => window.authFunctions.signOut(window.auth)} className="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-red-400 transition-colors"><LogOut /></button></div>
                    </header>
                    <div className="flex-1 flex flex-col md:flex-row relative z-10">
                        <aside className="w-full md:w-72 p-6 flex flex-col gap-6 border-r border-white/10 bg-[#0f172a]/80 backdrop-blur-md md:h-[calc(100vh-80px)] md:sticky md:top-[80px] overflow-y-auto">
                            <div className="bg-black/40 p-4 rounded-xl border border-white/10 retro-font">
                                <div className="flex items-center justify-between mb-2"><span className="text-xs text-gray-400">Rau-Pithampur</span>{weather.desc.includes('Rain') ? <CloudRain className="w-5 h-5 text-blue-400" /> : <Sun className="w-5 h-5 text-yellow-400" />}</div>
                                <div className="text-2xl font-bold text-white">{weather.temp}°C</div>
                                <div className="text-xs text-gray-400 mb-2">{weather.desc}</div>
                                <div className="flex justify-between text-xs"><span className="text-green-400">AQI: {weather.aqi}</span><span className="text-blue-300">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                            </div>
                            <nav className="space-y-4 text-lg retro-font tracking-widest">
                                <button onClick={() => setView('map')} className={`block w-full text-left p-2 rounded hover:bg-white/10 transition-colors ${view === 'map' ? 'text-yellow-400' : 'text-white'}`}>MAP</button>
                                <button onClick={() => setView('bookings')} className={`block w-full text-left p-2 rounded hover:bg-white/10 transition-colors ${view === 'bookings' ? 'text-yellow-400' : 'text-white'}`}>MY BOOKINGS</button>
                                {user.email === ADMIN_EMAIL && <button onClick={() => setView('database')} className={`block w-full text-left p-2 rounded hover:bg-white/10 transition-colors ${view === 'database' ? 'text-yellow-400' : 'text-white'}`}>DATABASE</button>}
                                <div className="h-px bg-white/20 my-4"></div>
                                {['Sports', 'Admin', 'Auditorium'].map(cat => (
                                    <div key={cat}>
                                        <button onClick={() => toggleCategory(cat)} className={`w-full text-left p-2 rounded hover:bg-white/10 transition-colors text-sm text-green-400 flex justify-between items-center ${expandedCat === cat ? 'bg-white/10' : ''}`}>{cat === 'Admin' ? 'ADMIN BLOCK' : cat.toUpperCase()}<ChevronDown className={`w-4 h-4 transition-transform ${expandedCat === cat ? 'rotate-180' : ''}`} /></button>
                                        {expandedCat === cat && (<div className="ml-4 mt-2 space-y-1 border-l-2 border-white/20 pl-2">{getVenuesByCategory(cat).map(v => (<button key={v.id} onClick={() => setSelectedVenue(v)} className="block w-full text-left text-[10px] py-1 text-gray-400 hover:text-white hover:translate-x-1 transition-all">{v.name}</button>))}</div>)}
                                    </div>
                                ))}
                                <button onClick={() => setView('heatmap')} className={`block w-full text-left p-2 rounded hover:bg-white/10 transition-colors text-sm mt-4 flex items-center gap-2 ${view === 'heatmap' ? 'text-red-400' : 'text-red-300'}`}><BarChart3 /> HEATMAP</button>
                            </nav>
                        </aside>
                        <main className="flex-1 flex items-center justify-center p-6 relative min-h-[calc(100vh-80px)]">
                            {view === 'map' && (<PixelEarth venues={VENUES} bookings={bookings} onVenueClick={setSelectedVenue} />)}
                            {view === 'bookings' && (
                                <div className="w-full h-full bg-[#1e293b]/90 border-4 border-white p-8 overflow-y-auto backdrop-blur-sm relative flex flex-col rounded-xl shadow-2xl">
                                    <div className="flex justify-between items-center mb-8 border-b-4 border-white pb-4"><h2 className="text-3xl text-yellow-400 retro-font">MY BOOKINGS</h2><button onClick={() => setView('map')} className="text-gray-400 hover:text-white p-2 border-2 border-transparent hover:border-white transition-all"><ArrowLeft className="w-8 h-8" /></button></div>
                                    {bookings.filter(b => b.email === user.email).length === 0 ? (<div className="flex-1 flex items-center justify-center"><p className="text-gray-400 retro-font text-xl animate-pulse">NO ACTIVE QUESTS.</p></div>) : (<div className="grid gap-4 w-full">{bookings.filter(b => b.email === user.email).map(b => (<div key={b.id} className="bg-black/40 border-2 border-white p-6 flex justify-between items-center hover:bg-white/5 transition-colors"><div><div className="text-xl text-green-400 font-bold uppercase mb-2 retro-font">{b.venueName}</div><div className="text-md text-white font-mono">{b.date} @ {b.time}</div>{b.openChallenge && <div className="text-sm text-yellow-400 mt-2 animate-pulse">{'>'}{'>'} OPEN CHALLENGE ACTIVE</div>}</div><div className="flex gap-2"><button onClick={() => handleEdit(b)} className="bg-blue-500/20 p-2 rounded hover:bg-blue-500 text-blue-400 hover:text-white transition-colors"><EditIcon className="w-4 h-4"/></button><button onClick={() => handleCancel(b.id)} className="bg-red-500/20 p-2 rounded hover:bg-red-500 text-red-400 hover:text-white transition-colors"><XIcon className="w-4 h-4"/></button></div></div>))}</div>)}
                                </div>
                            )}
                            {view === 'heatmap' && (
                                <div className="w-full h-full bg-[#1e293b]/95 border-4 border-white p-8 overflow-y-auto backdrop-blur-sm relative flex flex-col rounded-xl shadow-2xl">
                                    <div className="flex justify-between items-center mb-8 border-b-4 border-white pb-4"><h2 className="text-3xl text-red-400 retro-font">CAMPUS HEATMAP</h2><button onClick={() => setView('map')} className="text-gray-400 hover:text-white p-2 border-2 border-transparent hover:border-white transition-all"><ArrowLeft className="w-6 h-6" /></button></div>
                                    <div className="bg-black border-2 border-purple-500 p-6 mb-8 text-sm font-mono text-purple-300 leading-relaxed shadow-[0_0_15px_rgba(168,85,247,0.3)]">{aiInsight}</div>
                                    <div className="flex-1 w-full overflow-x-auto"><div className="min-w-[600px]"><div className="flex mb-4 ml-48">{TIME_SLOTS.map(t => (<div key={t} className="flex-1 text-center text-xs text-gray-400 -rotate-45 origin-bottom">{t}</div>))}</div><div className="space-y-3">{VENUES.map(v => (<div key={v.id} className="flex items-center gap-4"><span className="w-48 text-xs uppercase font-mono text-right truncate pr-4 text-gray-300">{v.name}</span><div className="flex-1 h-10 bg-black border border-white/20 flex relative group">{TIME_SLOTS.map((slot) => {const isBooked = bookings.some(b => b.venueId === v.id && b.time.startsWith(slot));return (<div key={slot} className={`flex-1 border-r border-white/10 transition-all hover:opacity-80 relative ${isBooked ? 'bg-red-500' : 'bg-transparent hover:bg-white/10'}`}><div className="opacity-0 group-hover:opacity-100 absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-[10px] bg-black border border-white px-1 pointer-events-none z-20 whitespace-nowrap text-white">{slot}</div></div>);})}</div></div>))}</div></div></div>
                                </div>
                            )}
                            {view === 'database' && (
                                <div className="w-full h-full bg-[#1e293b]/95 border-4 border-white p-8 overflow-y-auto backdrop-blur-sm relative flex flex-col rounded-xl shadow-2xl">
                                    <div className="flex justify-between items-center mb-8 border-b-4 border-white pb-4"><h2 className="text-3xl text-yellow-400 retro-font">BOOKINGS DATABASE</h2><button onClick={() => setView('map')} className="text-gray-400 hover:text-white p-2 border-2 border-transparent hover:border-white transition-all"><ArrowLeft className="w-8 h-8" /></button></div>
                                    <div className="flex gap-4 mb-4"><div className="relative flex-1"><Search className="absolute left-3 top-2.5 w-5 h-5 text-gray-400" /><input type="text" placeholder="Search bookings..." className="w-full bg-black border border-gray-600 pl-10 pr-4 py-2 text-white focus:outline-none focus:border-yellow-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div><button onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')} className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white"><Filter className="w-4 h-4" /> Sort by Date {sortOrder === 'asc' ? '↑' : '↓'}</button></div>
                                    <div className="retro-table-container">
                                        <table className="retro-table">
                                            <thead><tr><th>#</th><th>VENUE</th><th>DATE</th><th>TIME</th><th>USER</th><th>EMAIL</th><th>PURPOSE</th></tr></thead>
                                            <tbody>{filteredBookings.map((b, i) => (<tr key={b.id}><td className="row-id">{i+1}</td><td>{b.venueName}</td><td>{b.date}</td><td>{b.time}</td><td>{b.user}</td><td style={{textTransform:'lowercase'}}>{b.email}</td><td>{b.purpose}</td></tr>))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                    {(selectedVenue || editingBooking) && (<BookingModal venue={selectedVenue} bookingToEdit={editingBooking} onClose={() => { setSelectedVenue(null); setEditingBooking(null); }} onConfirm={handleBookingConfirm} />)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PixelPlanetApp />);
    </script>
</body>
</html>
